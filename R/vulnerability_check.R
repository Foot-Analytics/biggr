#' Check for vulnerabilities in package dependencies
#'
#' This function checks for vulnerabilities in the package dependencies using the OSS Index
#' via the oysteR package. It helps ensure ISO compliance by identifying security issues
#' in the dependencies.
#'
#' @param create_issue Logical. If TRUE, creates an issue if critical vulnerabilities are found.
#' Default is TRUE.
#' @param severity_threshold Character. Minimum severity level to report. Options are "critical",
#' "high", "medium", "low". Default is "critical".
#' @param output_file Character. Path to save the vulnerability report. If NULL, no file is saved.
#' Default is NULL.
#'
#' @return A data frame containing the vulnerability report.
#'
#' @examples
#' \dontrun{
#' # Check for critical vulnerabilities and create an issue if found
#' check_vulnerabilities()
#'
#' # Check for high or critical vulnerabilities but don't create an issue
#' vuln_report <- check_vulnerabilities(create_issue = FALSE, severity_threshold = "high")
#'
#' # Save the vulnerability report to a file
#' check_vulnerabilities(output_file = "vulnerability_report.csv")
#' }
#'
#' @export
check_vulnerabilities <- function(create_issue = TRUE, 
                                 severity_threshold = "critical",
                                 output_file = NULL) {
  # Check if oysteR is installed
  if (!requireNamespace("oysteR", quietly = TRUE)) {
    message("Installing oysteR package for vulnerability scanning...")
    utils::install.packages("oysteR")
  }
  
  # Load oysteR
  requireNamespace("oysteR", quietly = TRUE)
  
  # Get package dependencies
  pkg_deps <- utils::packageDescription("biggr")$Depends
  pkg_deps <- c(pkg_deps, utils::packageDescription("biggr")$Imports)
  pkg_deps <- c(pkg_deps, utils::packageDescription("biggr")$Suggests)
  
  # Clean up package names
  pkg_deps <- gsub("\\s", "", pkg_deps)
  pkg_deps <- gsub("\\(.*\\)", "", pkg_deps)
  pkg_deps <- pkg_deps[!grepl("^R$", pkg_deps)]
  pkg_deps <- unique(pkg_deps)
  
  # Scan for vulnerabilities
  message("Scanning for vulnerabilities in package dependencies...")
  vuln_report <- oysteR::audit_packages(pkg_deps)
  
  # Filter by severity threshold
  severity_levels <- c("critical", "high", "medium", "low")
  severity_index <- match(tolower(severity_threshold), severity_levels)
  
  if (!is.na(severity_index)) {
    relevant_levels <- severity_levels[1:severity_index]
    filtered_vulns <- vuln_report[vuln_report$severity %in% relevant_levels, ]
  } else {
    warning("Invalid severity threshold. Using 'critical' as default.")
    filtered_vulns <- vuln_report[vuln_report$severity == "critical", ]
  }
  
  # Create an issue if critical vulnerabilities are found and create_issue is TRUE
  if (create_issue && nrow(filtered_vulns) > 0) {
    issue_title <- paste0("Security Alert: ", nrow(filtered_vulns), 
                         " ", paste(relevant_levels, collapse = "/"), 
                         " vulnerabilities found")
    
    issue_body <- paste0("## Security Vulnerability Report\n\n",
                        "The following ", nrow(filtered_vulns), " vulnerabilities were found:\n\n")
    
    for (i in 1:nrow(filtered_vulns)) {
      vuln <- filtered_vulns[i, ]
      issue_body <- paste0(issue_body, 
                          "### ", i, ". ", vuln$package, " (", vuln$severity, ")\n",
                          "- Title: ", vuln$title, "\n",
                          "- Description: ", vuln$description, "\n",
                          "- CVSS Score: ", vuln$cvss_score, "\n",
                          "- Reference: ", vuln$reference, "\n\n")
    }
    
    issue_body <- paste0(issue_body, 
                        "Please update these dependencies as soon as possible to address these security issues.")
    
    message("Creating issue: ", issue_title)
    # Here you would integrate with your issue tracking system
    # For GitHub, you could use the gh package
    # For other systems, you might need different approaches
    
    # Example with GitHub (commented out as it requires additional setup)
    # if (requireNamespace("gh", quietly = TRUE)) {
    #   gh::gh("POST /repos/{owner}/{repo}/issues",
    #          owner = "your_github_username",
    #          repo = "your_repo_name",
    #          title = issue_title,
    #          body = issue_body)
    # }
    
    # For now, just print the issue to console
    message("Issue Title: ", issue_title)
    message("Issue Body: \n", issue_body)
  }
  
  # Save report to file if requested
  if (!is.null(output_file)) {
    utils::write.csv(vuln_report, file = output_file, row.names = FALSE)
    message("Vulnerability report saved to: ", output_file)
  }
  
  # Return the vulnerability report
  return(vuln_report)
}