# Tests for vulnerability checking functionality

test_that("vulnerability check function exists", {
  expect_true(exists("check_vulnerabilities"))
})

test_that("vulnerability check function has correct parameters", {
  # Get the function arguments
  args <- formals(check_vulnerabilities)
  
  # Check that the expected parameters exist with correct defaults
  expect_true("create_issue" %in% names(args))
  expect_true("severity_threshold" %in% names(args))
  expect_true("output_file" %in% names(args))
  
  # Check default values
  expect_equal(args$create_issue, TRUE)
  expect_equal(args$severity_threshold, "critical")
  expect_equal(args$output_file, NULL)
})

# Skip actual vulnerability check tests in automated testing
# as they require network access and can be slow
test_that("vulnerability check mock test", {
  skip_if_not_installed("oysteR")
  skip_on_cran()
  
  # Mock the audit_packages function to avoid actual API calls
  with_mock(
    `oysteR::audit_packages` = function(...) {
      data.frame(
        package = c("pkg1", "pkg2"),
        version = c("1.0.0", "2.0.0"),
        title = c("Vuln 1", "Vuln 2"),
        description = c("Description 1", "Description 2"),
        cvss_score = c(9.8, 7.5),
        severity = c("critical", "high"),
        reference = c("ref1", "ref2"),
        stringsAsFactors = FALSE
      )
    },
    {
      # Test with default parameters
      result <- check_vulnerabilities(create_issue = FALSE)
      expect_s3_class(result, "data.frame")
      expect_equal(nrow(result), 2)
      
      # Test with high severity threshold
      result_high <- check_vulnerabilities(
        create_issue = FALSE, 
        severity_threshold = "high"
      )
      expect_s3_class(result_high, "data.frame")
      
      # Test with output file
      temp_file <- tempfile(fileext = ".csv")
      on.exit(unlink(temp_file), add = TRUE)
      
      result_file <- check_vulnerabilities(
        create_issue = FALSE,
        output_file = temp_file
      )
      expect_true(file.exists(temp_file))
    }
  )
})